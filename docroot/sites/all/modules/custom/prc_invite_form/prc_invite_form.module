<?php

/**
 * @file
 * Alters to user edit forms.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function prc_invite_form_form_invite_form_alter(&$form, &$form_state) {
  _prc_invite_form_set_title();

  // Change mail label and description, and make it a multi-line text area
  $mail = array(
    '#required' => '1',
    '#description' => t('Input email addresses of users you want to invite. Put each address on a separate line. Each person will receive an invitation to join the site.'),
    '#weight' => '0',
    '#type' => 'textarea',
    '#title' => t('E-mail'),
  );
  $form['field_multi_emails'] = $mail;

  // We are leaving out the standard Invite email fields...
  $form['field_invitation_email_address']['#access'] = FALSE;
  $form['field_invitation_email_subject']['#access'] = FALSE;
  $form['field_invitation_email_body']['#access'] = FALSE;
  $form['token_help']['#access'] = FALSE;

  // ...and adding our own.
  $default_message_text = "I'd like to invite you to the PARCC Partnership Resource Center.";
  $form['prc_invite_message'] = array(
    '#required' => '1',
    '#description' => t('You can personalize the message that will be sent in the invitation email.'),
    '#weight' => '1',
    '#type' => 'textarea',
    '#title' => t('Message'),
    '#default_value' => $default_message_text,
  );

  // And add a set of radio buttons for roles...
  $roles = _prc_invite_form_invite_roles();
  $form['invite_role'] = array(
    '#type' => 'radios',
    '#title' => 'Role',
    '#description' => 'Users invited will have the role selected.',
    '#required' => TRUE,
    '#access' => TRUE,
    '#options' => $roles,
  );

  // Hide the field_role_id field - we'll use this to save the role we pick in invite_role
  if (array_key_exists('field_role_id', $form)) {
    $form['field_role_id']['#access'] = FALSE;
  }

  // Change the text of the -- None -- option
  $form['field_member_state'][LANGUAGE_NONE]['#options']['_none'] = t('Select a state');

  // Now make the Member State dropdown dependent on the Role selected
  $form['field_member_state']['#states'] = array(
    'visible' => array(
      ':input[name="invite_role"]' => array(
        array('value' => '7'), // PARCC-Member Educator
        array('value' => '6'), // Content Contributor
      ),
    ),
  );

  // Change the title of Member State to State
  $form['field_member_state']['und']['#title'] = t('State');

  $form['#validate'][] = 'prc_invite_form_form_invite_form_validate';

  foreach ($form['#validate'] as $key => $og_user_node) {
    if ($og_user_node == "invite_by_email_form_invite_form_validate") {
      unset ($form['#validate'][$key]);
    }
  }

  // in form action, add prc_invite_form_form_invite_form_submit submit, remove invited_edit_form_submit,
  // and make sure this all happens before ctools_wizard_submit
  if (isset($form['actions']['submit']['#submit'])) {
    array_unshift($form['actions']['submit']['#submit'], 'prc_invite_form_form_invite_form_submit');
    foreach ($form['actions']['submit']['#submit'] as $key => $og_user_node) {
      if ($og_user_node == "invite_form_submit") {
        unset ($form['actions']['submit']['#submit'][$key]);
      }
    }
  }

}

function _prc_invite_form_invite_roles() {
  $all_roles = user_roles();
  $omit_roles = array('administrator', 'anonymous user', 'authenticated user');
  $roles = array_diff($all_roles, $omit_roles);
  return $roles;
}

function _prc_invite_form_set_title() {
  drupal_set_title('Invite New PRC Website User');
}

function prc_invite_form_form_invite_form_validate($form, &$form_state)
{
  _prc_invite_form_set_title();

  if (
    empty($form_state['values']['field_invitation_email_address']) &&
    !empty($form_state['input']['field_invitation_email_address'])
  ) {
    $form_state['values']['field_invitation_email_address'] = $form_state['input']['field_invitation_email_address'];
  }

  $valid_emails = array();
  _prc_invite_form_validate_email_address_format($form_state, 'field_multi_emails', $valid_emails);
  $form_state['invitees'] = $valid_emails;

  // Notify field widgets to validate their data.
  field_attach_form_validate('invite', $form_state['invite'], $form, $form_state);
}

/**
 * @param $form_state
 * @return mixed
 */
function _prc_invite_form_validate_email_address_format(&$form_state, $field_name, &$valid_emails) {
  if (isset($form_state['values'][$field_name])) {
    $valid = array();
    $invalid = array();

    $trimmed_emails = trim($form_state['values'][$field_name]);

    // Allow multiple delimiters. Fixes DEU problems and currently the Behat test can't put a linebreak into the textarea
    $trimmed_emails = str_replace(',', "\n", $trimmed_emails);
    $trimmed_emails = str_replace(';', "\n", $trimmed_emails);

    foreach (explode("\n", $trimmed_emails) as $email) {
      $email = trim($email);
      if (!empty($email)) {
        if (valid_email_address($email)) {
          $valid[] = $email;
        }
        else {
          $invalid[] = $email;
        }
      }
    }
    if (empty($invalid)) {
      //$form_state['invitees'] = $valid;
      $valid_emails = $valid;
    }
    elseif (count($invalid) == 1) {
      form_set_error($field_name, t('%email is not a valid e-mail address.', array('%email' => reset($invalid))));
    }
    else {
      form_set_error($field_name, t('%emails are not valid e-mail addresses.', array('%emails' => implode(', ', $invalid))));
    }
    if (empty($valid) && empty($invalid)) {
      form_set_error($field_name, t('Please input one or more email addresses'));
    }
  }
}

// each email address needs its own invite object
// so we tell the entity builder that this guy is new
function _prc_invite_form_invitations_entity_builder($entity_type, $entity, $form, $form_state)
{
  if (!isset($entity->is_new)) {
    $entity->is_new = TRUE;
    // we want a new invites token, so unset token if it exists
    if (isset($entity->invites_token)) {
      unset ($entity->invites_token);
    }
    // and reset the invites id
    $entity->invites_id = '';
  }
}

function prc_invite_form_form_invite_form_submit(&$form, &$form_state)
{
  $entity_builders = array('_prc_invite_form_invitations_entity_builder');
  if (array_key_exists('#entity_builders', $form)) {
    $entity_builders += $form['#entity_builders'];
  }
  $form['#entity_builders'] = $entity_builders;
  $new_body = $form_state['values']['prc_invite_message'] . '<br />' . $form_state['values']['field_invitation_email_body'][LANGUAGE_NONE][0]['value'];
  $form_state['values']['field_invitation_email_body'][LANGUAGE_NONE][0]['value'] = $new_body; // .= pre-concat operator not working
  $rid = $form_state['values']['invite_role'];
  $form_state['values']['field_role_id'][LANGUAGE_NONE][0]['value'] = $rid;

  if ($rid != 6 && $rid != 7) {
    // Force no state on any role except PARCC-Member Educator or Content Contributor
    $form_state['values']['field_member_state'][LANGUAGE_NONE][0]['tid'] = NULL;
  }

  foreach ($form_state['invitees'] as $key => $invitee) {
    // invite to group
    //$form_state['values']['field_invitation_email_address'] = $invitee;
    $form_state['values']['field_invitation_email_address'][LANGUAGE_NONE][0]['value'] = $invitee;
    invite_form_submit($form, $form_state);
    $form_state['invite']->reg_code = invite_generate_code();
    unset($form_state['invite']->iid);
  }
}

/**
 *  Implements hook_invite_accept().
 */
function prc_invite_form_invite_accept($invite) {
  $w = entity_metadata_wrapper('invite', $invite);
  $invitee = $invite->invitee;
  $account = user_load($invitee);
  $invite_rid = $w->field_role_id->value();
  $roles = user_roles(TRUE);
  if (isset($roles[$invite_rid])) {
    $role_name = $roles[$invite_rid];
    // Users get Educator by default, so don't do anything funky if it's an Educator invite
    if ($role_name != 'Educator') {
      $new_roles = array();
      // Remove all other roles from the user
      foreach ($roles as $rid => $rname) {
        $new_roles[$rid] = 0;
      }
      // Add authenticated user back in
      $new_roles[2] = $roles[2];
      $new_roles[$invite_rid] = $role_name;
      // Add role to user
      user_save($account, array('roles' => $new_roles));
    }
  }
}

/**
 *  Implements hook_token_info().
 */
function prc_invite_form_token_info() {
  $types = array();
  $tokens = array();

  $tokens['invite']['role-name'] = array(
    'name' => t('Role Name'),
    'description' => t('Displays role name from the field_role_id field (includes "a" or "an", eg, "an Educator" or "a Content Author".'),
  );

  return array(
    'types' => $types,
    'tokens' => $tokens,
  );
}

/**
 *  Implements hook_tokens().
 */
function prc_invite_form_tokens($type, $tokens, array $data = array(), array $options = array()) {
  $langcode = LANGUAGE_NONE;
  if (isset($options['language'])) {
    $url_options['language'] = $options['language'];
    $langcode = $options['language']->language;
  }

  $replacements = array();
  // URL tokens.
  if ($type == 'invite' && !empty($data['invite'])) {
    foreach ($tokens as $name => $original) {
      switch ($name) {
        case 'role-name':
          $invite = $data['invite'];
          $rid = $invite->field_role_id[$langcode][0]['value'];
          $roles = user_roles();
          $role_name = $roles[$rid];
          $replacements[$original] = $role_name;
          break;
      }
    }
  }
  return $replacements;
}