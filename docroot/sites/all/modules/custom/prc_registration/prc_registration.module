<?php

/**
 * @file
 * Alters to registration forms.
 */

/**
 * Implements hook_form_FORM_ID_alter
 *
 * Changes the title of the registration form
 *
 * @param $form
 * @param $form_state
 */
function prc_registration_form_user_register_form_alter(&$form, &$form_state) {
  drupal_set_title('Create User Account to Join Partnership Resource Center');
  $invite = invite_load_from_session();
  // We don't want to display any of this stuff if the user is coming from an invite
  if (!$invite) {
    $profession_weight = $form['field_user_state']['#weight'];

    //variable to hold the selector for the state field
    $state_field = ':input[name="field_user_state[und]"]';

    $form['state_account_number'] = array(
      '#type' => 'textfield',
      '#title' => t('State Account #'),
      '#weight' => $profession_weight + 2,
      '#states' => array(
        'visible' => array(
          $state_field => array(),
        ),
        'required' => array(
          $state_field => array(),
        ),
      ),
    );

    $form['#validate'][] = 'prc_registration_form_user_register_form_validate';

    //Mark the states that are PARCC in the user states dropdown
    //Make it so the account number text box appears when they are selected
    $p_states = db_query('select name from taxonomy_term_data where vid = (
      select vid from taxonomy_vocabulary where machine_name = \'member_state\')')->fetchCol('vid');
    foreach($form['field_user_state']['und']['#options'] as $tid => &$term){
      if(in_array($term, $p_states)){
        $term = $term.' (PARCC Member)';
        $form['state_account_number']['#states']['visible'][$state_field][] = array('value' => $tid);
      }
    }
  }
}


/**
 * Validate for user registration form
 *
 * @param $form
 * @param $form_state
 */
function prc_registration_form_user_register_form_validate(&$form, &$form_state) {
  $invite = invite_load_from_session();
  if ($invite && count($invite->field_member_state)) {
    $tid = $invite->field_member_state[LANGUAGE_NONE][0]['tid'];
    $form_state['values']['field_member_state'][LANGUAGE_NONE][0]['tid'] = $tid;
  }

  if(!empty($form_state['values']['state_account_number'])) {
    $account_number = $form_state['values']['state_account_number'];

    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'taxonomy_term')
      ->entityCondition('bundle', 'member_state')
      ->fieldCondition('field_state_code', 'value', $account_number, '=');
    $result = $query->execute();
    if (array_key_exists('taxonomy_term', $result)) {
      $tids = array_keys($result['taxonomy_term']);
      $tid = reset($tids);
      $form_state['values']['field_member_state'][LANGUAGE_NONE][0]['tid'] = $tid;
    }
    else {
      form_set_error('state_account_number', t('Valid State Account # is incorrect.  Leave this blank if you do not have one.'));
    }
  }
}