<?php
/**
 * @file
 * PRC Technology Readiness Tool module code.
 */

/**
 * Implements hook_menu().
 */
function prc_trt_menu() {
	$items = array();

	$items['technology-readiness'] = array(
		'title' => 'Technology Readiness',
		'description' => 'Determine whether a computer is capable of executing PARCC test assessments',
		'type' => MENU_NORMAL_ITEM,
		'page callback' => 'drupal_get_form',
		'page arguments' => array('prc_trt_form'),
		'access arguments' => array('access trt'),
	);

	$items['technology-readiness/test'] = array(
		'title' => 'Technology Readiness',
		'type' => MENU_CALLBACK,
		'page callback' => 'prc_trt_test',
		'access arguments' => array('access trt'),
	);

	return $items;
}


/**
 * Implements hook_permission().
 */
function prc_trt_permission() {
	return array(
		'access trt' => array(
			'title' => t('Access Technology Readiness Tool'),
			'description' => t('Access the Technology Readiness Tool to run a test to determine whether a computer is capable of executing PARCC test assessments'),
		),
	);
}


/**
 * Implements hook_form().
 * Defines the initial information form required to begin the TRT.
 */
function prc_trt_form($form, &$form_state) {
	$form['trt_intro_text'] = array(
		'#markup' => t('<p>The purpose of the Technology Readiness Tool is to provide a way for districts and schools to determine if the needed technical requirements are currently available to perform the PARCC Assessments online. This tool will check the following information for the specific device being tested.</p><ul><li>IP Address</li><li>Browser</li><li>Operating System</li><li>Internet Connectivity</li><li>Testing Capacity</li></ul>'),
	);

	$form['trt_instructions'] = array(
		'#markup' => t('<p>To start this Technology Readiness test, simply enter the information below and select the "Begin Test" button.</p>'),
	);

	$form['trt_device'] = array(
		'#type' => 'select',
		'#title' => t('Hardware/Device'),
		'#options' => array(
			'desktop' => 'Desktop',
			'laptop' => 'Laptop',
			'tablet' => 'Tablet',
		),
		'#required' => TRUE,
	);

	$form['trt_student_count'] = array(
		'#type' => 'textfield',
		'#title' => t('Total # of Students'),
		'#size' => 5,
		'#required' => TRUE,
	);

	$form['trt_device_count'] = array(
		'#type' => 'textfield',
		'#title' => t('Total # of Hardware/Devices'),
		'#size' => 5,
		'#required' => TRUE,
	);

	$form['trt_user_comments'] = array(
		'#type' => 'textarea',
		'#title' => t('Additional Comments (optional)'),
	);

	$form['trt_submit'] = array(
		'#type' => 'submit',
		'#value' => t('Begin Test'),
	);

	return $form;
}


/**
 * Implements hook_form_validate().
 * Validates the initial information form required to begin the TRT.
 */
function prc_trt_form_validate($form, &$form_state) {
	if(!(is_numeric($form_state['values']['trt_student_count']))) {
		form_set_error('trt_student_count', t('Total # of Students must be a positive integer.'));
	}

	if(!(is_numeric($form_state['values']['trt_device_count']))) {
		form_set_error('trt_device_count', t('Total # of Hardware/Devices must be a positive integer.'));
	}
}


/**
 * Implements hook_form_submit().
 * Executes the TRT upon valid submission of the initial information form.
 */
function prc_trt_form_submit($form, &$form_state) {
	$trt_data = array(
		'trtDevice' => $form_state['values']['trt_device'],
		'trtStudentCount' => $form_state['values']['trt_student_count'],
		'trtDeviceCount' => $form_state['values']['trt_device_count'],
		'trtUserComments' => $form_state['values']['trt_user_comments'],
	);
	$_SESSION['trt_data'] = $trt_data;

	$form_state['redirect'] = 'technology-readiness/test';
}


/**
 * Delivers the main test page.
 */
function prc_trt_test() {
	// Redirect to the test form page if user data is not present,
	// such as if this URL was entered directly with bypassing the user form
	if(!isset($_SESSION['trt_data'])) {
		drupal_goto('technology-readiness');
	}

	drupal_add_library('system', 'ui.progressbar');
	drupal_add_js(drupal_get_path('module', 'prc_trt') . '/prc_trt.js');
	drupal_add_js('var trtData = ' . json_encode($_SESSION['trt_data']) . ';', 'inline');

	return array(
		'#markup' => '
<div id="trtInProgress" style="display: none;">
	<h2>Technology Readiness System Check</h2>
	<div id="trtInProgressMessage">In Progress...</div>
	<div id="trtProgressBar"></div>
	<span id="trtProgressBarLabel"></span>
</div>
<div id="trtResults" style="display: none;">
	<h3>IP Address, Browser, and Operating System</h3>
	<table>
		<thead>
			<tr>
				<th>Checks Performed</th>
				<th>Results</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>IP Address</td>
				<td><span id="trtResultIPAddress"></span></td>
			</tr>
			<tr>
				<td>Browser</td>
				<td><span id="trtResultBrowser"></span></td>
			</tr>
			<tr>
				<td>Operating System</td>
				<td><span id="trtResultOS"></span></td>
			</tr>
		</tbody>
	</table>
	<h3>Internet Connectivity</h3>
	<table>
		<thead>
			<tr>
				<th>Needs Attention</th>
				<th>Ok</th>
				<th>Good</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td><span id="trtResultInetConnectNeedsAttention"></span></td>
				<td><span id="trtResultInetConnectOk"></span></td>
				<td><span id="trtResultInetConnectGood"></span></td>
			</tr>
		</tbody>
	</table>
	<div id="trtResultInetConnectMessage">Internet connectivity requirements copy here</div>
	<h3>Testing Capacity</h3>
	<table>
		<thead>
			<tr>
				<th>Hardware/Device</th>
				<th>Total # of Devices</th>
				<th>Total # of Students</th>
				<th>Download Speed</th>
				<th>Testing Capacity Estimate</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td><span id="trtResultTestCapHardwareDevice"></span></td>
				<td><span id="trtResultTestCapDeviceCount"></span></td>
				<td><span id="trtResultTestCapStudentCount"></span></td>
				<td><span id="trtResultTestCapDownloadSpeed"></span></td>
				<td><span id="trtResultTestCapCapacityEstimate"></span></td>
			</tr>
		</tbody>
	</table>
	<h4>Additional Comments</h4>
	<div id="trtResultUserComments"></div>
</div>');
}
